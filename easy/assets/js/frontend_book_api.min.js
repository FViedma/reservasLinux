window.FrontendBookApi=window.FrontendBookApi||{},function(e){"use strict";var a,t,n=!1;function o(e,a,t){t=t||!1,n=!0;var o=Date.parse(a),i=new Date(o.getFullYear(),o.getMonth()+1,0).getDate();if(t&&!GlobalVariables.manageMode)for(var r=1;r<=i;r++){var l=new Date(o.getFullYear(),o.getMonth(),r);if(-1===e.indexOf(l.toString("yyyy-MM-dd"))){$("#select-date").datepicker("setDate",l),FrontendBookApi.getAvailableHours(l.toString("yyyy-MM-dd"));break}}e.length===i&&$("#available-hours").text(EALang.no_available_hours),$("#select-date .ui-datepicker-calendar td:not(.ui-datepicker-other-month)").each(function(a,t){o.set({day:a+1}),-1!==e.indexOf(o.toString("yyyy-MM-dd"))&&$(t).addClass("ui-datepicker-unselectable ui-state-disabled")}),n=!1}e.getAvailableHours=function(e){$("#available-hours").empty();var a=$("#select-service").val(),t=15,n=GlobalVariables.availableServices.find(function(e){return Number(e.id)===Number(a)});n&&(t=n.duration);var o=FrontendBook.manageMode?GlobalVariables.appointmentData.id:null,i=GlobalVariables.baseUrl+"/index.php/appointments/ajax_get_available_hours",r={csrfToken:GlobalVariables.csrfToken,service_id:$("#select-service").val(),provider_id:$("#select-provider").val(),selected_date:e,service_duration:t,manage_mode:FrontendBook.manageMode,appointment_id:o};$.post(i,r).done(function(a){if(a.length>0){var t=$("#select-provider").val();"any-provider"===t&&(t=GlobalVariables.availableProvidersReservation[0].id);var n=GlobalVariables.availableProvidersReservation.find(function(e){return Number(t)===Number(e.id)});if(!n)throw new Error("Could not find provider.");var o=n.timezone,i=$("#select-timezone").val(),r="regular"===GlobalVariables.timeFormat?"h:mm a":"HH:mm";a.forEach(function(a){var t=moment.tz(e+" "+a+":00",o).tz(i);$("#available-hours").append($("<button/>",{class:"btn btn-outline-secondary btn-block shadow-none available-hour",data:{value:a},text:t.format(r)}))}),FrontendBook.manageMode?$(".available-hour").removeClass("selected-hour").filter(function(){return $(this).text()===Date.parseExact(GlobalVariables.appointmentData.start_datetime,"yyyy-MM-dd HH:mm:ss").toString(r)}).addClass("selected-hour"):$(".available-hour:eq(0)").addClass("selected-hour"),FrontendBook.updateConfirmFrame()}else $("#available-hours").text(EALang.no_available_hours)})},e.registerAppointment=function(){var e=$(".captcha-text");if(e.length>0&&(e.closest(".form-group").removeClass("has-error"),""===e.val()))e.closest(".form-group").addClass("has-error");else{var a=JSON.parse($('input[name="post_data"]').val()),t={csrfToken:GlobalVariables.csrfToken,post_data:a};e.length>0&&(t.captcha=e.val()),GlobalVariables.manageMode&&(t.exclude_appointment_id=GlobalVariables.appointmentData.id);var n=GlobalVariables.baseUrl+"/index.php/appointments/ajax_register_appointment",o=$("<div/>");$.ajax({url:n,method:"post",data:t,dataType:"json",beforeSend:function(e,a){o.appendTo("body").css({background:"white",position:"fixed",top:"0",left:"0",height:"100vh",width:"100vw",opacity:"0.5"})}}).done(function(a){if(!1===a.captcha_verification)return $("#captcha-hint").text(EALang.captcha_is_wrong).fadeTo(400,1),setTimeout(function(){$("#captcha-hint").fadeTo(400,0)},3e3),$(".captcha-title button").trigger("click"),e.closest(".form-group").addClass("has-error"),!1;window.location.href=GlobalVariables.baseUrl+"/index.php/appointments/book_success/"+a.appointment_hash}).fail(function(e,a,t){$(".captcha-title button").trigger("click")}).always(function(){o.remove()})}},e.getUnavailableDates=function(e,i,r){if(!n&&e&&i){var l=FrontendBook.manageMode?GlobalVariables.appointmentData.id:null,s=GlobalVariables.baseUrl+"/index.php/appointments/ajax_get_unavailable_dates",d={provider_id:e,service_id:i,selected_date:encodeURIComponent(r),csrfToken:GlobalVariables.csrfToken,manage_mode:FrontendBook.manageMode,appointment_id:l};$.ajax({url:s,type:"GET",data:d,dataType:"json"}).done(function(e){a=e,t=r,o(e,r,!0)})}},e.applyPreviousUnavailableDates=function(){o(a,t)},e.saveConsent=function(e){var a=GlobalVariables.baseUrl+"/index.php/consents/ajax_save_consent",t={csrfToken:GlobalVariables.csrfToken,consent:e};$.post(a,t)},e.deletePersonalInformation=function(e){var a=GlobalVariables.baseUrl+"/index.php/privacy/ajax_delete_personal_information",t={csrfToken:GlobalVariables.csrfToken,customer_token:e};$.post(a,t).done(function(){window.location.href=GlobalVariables.baseUrl})},e.getPatientByCI=function(e,a){var t=GlobalVariables.baseUrl+"/index.php/Backend_api/ajax_get_patient_by_ci",n={patientCI:e,complement:a};$.ajax({url:t,type:"GET",data:n,dataType:"json"}).done(function(t){0==t.length?($("#form-message").empty(),$("#appointment-message").empty(),$("#button-next-1").prop("disabled",!0),GeneralFunctions.displayMessageBox(EALang.message,EALang.patient_not_registered)):t.length>0?t.forEach(t=>{$("#form-message").empty(),$("#appointment-message").empty(),$("#nombre_paciente").val(t.HCL_NOMBRE),$("#ape_paciente").val(t.HCL_APPAT+" "+t.HCL_APMAT),$("#clinic_story").val(t.HCL_CODIGO);var n=t.HCL_NOMBRE+" "+t.HCL_APPAT+" "+t.HCL_APMAT;$("#form-message").append(function(e,a,t){return $("<div/>",{class:"card",html:[$("<div/>",{class:"card-header bg-success",html:[$("<h5/>",{text:EALang.patient_registered})]}),$("<div/>",{class:"card-text",text:"Paciente: "+e+" con CI: "+a+" tiene la Historia Clínica: "+t})]})}(n,t.HCL_NUMCI,t.HCL_CODIGO)),function(e,a){var t=GlobalVariables.baseUrl+"/index.php/Backend_api/ajax_get_patient_reservation",n={patientCI:e,complement:a};$.ajax({url:t,type:"GET",data:n,dataType:"json"}).done(function(e){if(null==e)$("#appointment-message").empty(),$("#button-next-1").prop("disabled",!0),GeneralFunctions.displayMessageBox(EALang.message,EALang.patient_not_found);else if(e.length>=1){var e=e[0];$("#button-next-1").prop("disabled",!1);var a=new Date(e.book_datetime);(function(e,a){var t=!1,n=!1,o=!1;e.getFullYear()==e.getFullYear()&&(t=!0);e.getMonth()===a.getMonth()&&(n=!0);e.getDate()===a.getDate()&&(o=!0);return t==n&&n==o})(a,new Date)&&($("#appointment-message").append((t=e.book_datetime,n=e.service.name,o=e.provider.first_name,i=e.provider.last_name,$("<div/>",{class:"card",html:[$("<div/>",{class:"card-header bg-success",html:[$("<h5/>",{text:EALang.patient_appointed})]}),$("<div/>",{class:"card-text",text:"El paciente ya cuenta con una reserva Reserva: "+t+" Especialidad: "+n+" Médico: "+o+" "+i})]}))),$("#button-next-1").prop("disabled",!0))}else $("#button-next-1").prop("disabled",!1);var t,n,o,i})}(e,a)}):$("#manage-appointment").find("#first-name, #last-name,#clinical-story").val("")})}}(window.FrontendBookApi);